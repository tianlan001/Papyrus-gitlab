<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><p><h1>Table of Contents</h1></p><ol style="list-style: none;"><li><a href="#Facets">Facets</a></li><li><a href="#FacetSets">FacetSets</a><ol style="list-style: none;"><li><a href="#Metamodel">Metamodel</a></li><li><a href="#Hierarchical_FacetSets">Hierarchical FacetSets</a></li><li><a href="#Registration">Registration</a></li><li><a href="#Catalog">Catalog</a></li></ol></li><li><a href="#Queries">Queries</a><ol style="list-style: none;"><li><a href="#Query_source_and_return_type">Query source and return type</a></li><li><a href="#Java_queries">Java queries</a></li><li><a href="#Literal_Query_Types">Literal Query Types</a></li><li><a href="#Operation_Call_Query">Operation Call Query</a><ol style="list-style: none;"><li><a href="#Operation_Call_Query_source_and_return_type">Operation Call Query source and return type</a></li></ol></li></ol></li><li><a href="#Facet_manager">Facet manager</a></li></ol><h2 id="Facets">Facets</h2><p>A central concept in EMF Facet is the <b>Facet</b>. A Facet is a kind of virtual metaclass extension. Those "virtual" metaclasses can never be actually instantiated. Instead, a model element is said to <b>conform</b> to a Facet if it matches a predicate defined on this Facet.</p><p>For example, let's assume we have a metamodel with an "Employee" metaclass, and we have defined two Facets named "Manager" and "Developer". We can have a model containing instances of the Employee metaclass; some of these may conform to the "Manager" Facet, and others may conform to the "Developer" Facet.</p><p>Additionally, a Facet may contain facet elements: attributes, references and operations. These Facet elements always have to be derived.</p><p>Defining a Facet can be useful:</p><ul><li>when there is a need to categorize model elements more precisely than done in the metamodel</li><li>to make it easier to highlight model elements that conform to a particular Facet</li><li>to add information in a non-intrusive way to an existing metamodel</li><li>to make navigating a model easier by providing shortcuts to relevant information</li></ul><h2 id="FacetSets">FacetSets</h2><p>Facets are contained in <b>FacetSets</b>. A FacetSet — as its name indicates — is a set of Facets. A FacetSet is defined in a model that is most commonly saved in an EMF XMI file which must conform to the efacet metamodel (<b>http://www.eclipse.org/papyrus/emf/facet/efacet/0.2.incubation/efacet</b>). A FacetSet model file must have the file extension ".efacet".</p><h3 id="Metamodel">Metamodel</h3><p>Here is what the efacet metamodel looks like. This diagram was a bit simplified to show only the most important concepts: </p><p><img border="0" src="../img/facetSet.png"/></p><ul><li>A FacetSet is actually an EPackage, which contains Facets under the <b>eClassifiers</b> reference of the EPackage metaclass.</li><li>A Facet extends a metaclass (defined in an ecore metamodel), and it has an optional conformance element. The conformance element takes an instance of the Facet's extended metaclass as source, and returns a boolean indicating whether the given instance conforms to the Facet. To conform to a Facet, a model element has to be an instance of the Facet's extended metaclass, and the Facet's conformance element must return true for this model element.</li><li>A Facet may contain <b>FacetElements</b> and <b>FacetOperations</b>. A FacetElement may be a <b>FacetAttribute</b> or a <b>FacetReference</b>.</li><li>FacetAttribute, FacetReference and FacetOperation all extend <b>DerivedTypedElement</b>. A DerivedTypedElement is a typed element that returns a value based on the evaluation of a <a href="#Queries">query</a>. A derived typed element is always contained in a Facet.</li><li>A FacetAttribute is an EAttribute, a FacetReference is an EReference, and a FacetOperation is an EOperation. All three are derived and evaluated using a query.</li></ul><h3 id="Hierarchical_FacetSets">Hierarchical FacetSets</h3><p>A FacetSet can contain other FacetSets, using the <b>eSubpackages</b> containment reference:</p><p><img border="0" src="../img/library.png"/></p><p>In this example, we define a FacetSet for a library metamodel. We sub-divide the "library" FacetSet into two FacetSets : one dedicated to writers and the other one to books. The "writer" FacetSet contains Facets related to writers, and the "book" FacetSet contains Facets related to books.</p><h3 id="Registration">Registration</h3><p>In order for a FacetSet to be available at runtime in the FacetSet catalog, it must be registered with extension point <b>org.eclipse.papyrus.emf.facet.util.emf.core.modeldeclaration</b>, like this:</p><pre>
&lt;extension point="org.eclipse.papyrus.emf.facet.util.emf.core.modeldeclaration"&gt;
  &lt;modeldeclaration file="myFacetSet.efacet"/&gt;
&lt;/extension&gt;
</pre><p>Also, your ".efacet" file must be included in your plug-in's build.properties in order to be available in deployed plug-ins.</p><h3 id="Catalog">Catalog</h3><p>FacetSets that have been <a href="#Registration">registered</a> are available from the FacetSet catalog.
For example, if you want to retrieve the list of all registered FacetSets:</p><pre>
IFacetSetCatalogManager catalogMgr = IFacetSetCatalogManagerFactory.DEFAULT
    .getOrCreateFacetSetCatalogManager(new ResourceSetImpl());
Collection&lt;FacetSet&gt; allFacetSets = catalogMgr.getRegisteredFacetSets();
</pre><p>Then you can for example look for a FacetSet with a given name in the previous list:</p><pre>
FacetSet myFacetSet = FacetUtils.getFacetSet(allFacetSets, "MyFacetSet");
</pre><h2 id="Queries">Queries</h2><p>A <b>Query</b> in EMF Facet is used to compute a derived typed element (i.e. a Facet attribute, reference or operation). A query's only purpose is to lend its value to its containing derived typed element.</p><h3 id="Query_source_and_return_type">Query source and return type</h3><p>A query is evaluated on a <b>source</b> element, and it <b>returns</b> a value. </p><p>A query's <b>source type</b> is the type of the element the query is evaluated on.</p><p>A derived typed element can only be evaluated on <b>instances of the metaclass</b> extended by the Facet in which the derived typed element is defined, for instances that <b>conform to this Facet</b>. </p><p>So, there are two ways to determine the source type of a derived typed element. </p><p>The <b>first case</b> is when the Facet that contains the derived typed element extends a metaclass "directly"; then the <b>source type</b> is this metaclass that is extended by the Facet.</p><p>Here is an example where a query implements a FacetAttribute:</p><p><img border="0" src="../img/queryType1.png"/></p><p>The query's source type is the metaclass extended by the Facet in which the FacetAttribute implemented by the query is defined.</p><p>The <b>second case</b> is when a Facet extends another Facet: the <b>source type</b> of the derived typed element is now the metaclass extended by the topmost Facet in the inheritance tree.</p><p>Here is a similar example where the Facet extends another Facet:</p><p><img border="0" src="../img/queryType2.png"/></p><p>The query's <b>source type</b> is now the metaclass extended by the Facet extended by a second Facet in which the FacetAttribute implemented by the query is defined.</p><p>A query implements a derived typed element (such as a Facet attribute, reference or operation) to give it a value. As such, the <b>return type</b> of a query (the type of the value returned by the query) and the <b>multiplicity</b> of a query (whether the query returns one or more elements) are the same as the type and multiplicity of the derived typed element containing this query.</p><p>So in our example, the return type of query <b>q</b> is the EClassifier <b>t</b>, since <b>t</b> is the <b>eType</b> of the FacetAttribute <b>a</b> (which is the derived typed element that the query implements).</p><h3 id="Java_queries">Java queries</h3><p>EMF Facet provides a query type to define Java queries. You must define your Java queries in a Java class that implements the interface <b>org.eclipse.papyrus.emf.facet.query.java.core.IJavaQuery2</b>. The <i>IJavaQuery2</i> interface is parameterized with the source type and return type. For example, <code>IJavaQuery2&lt;Book, Boolean&gt;</code> indicates that the query's source type is <code>Book</code>, and the return type is <code>Boolean</code>.</p><p>For example, this query takes a Book and returns a boolean that indicates whether the given book has a long title (i.e. more than 30 characters in this example):</p><pre>
public class HasLongTitle implements IJavaQuery2&lt;Book, Boolean&gt; {
  public Boolean evaluate(final Book book, final IParameterValueList2 parameterValues, 
      final IFacetManager facetManager) throws DerivedTypedElementException {
    return book.getTitle().length() &gt; 30;
  }
}
</pre><h3 id="Literal_Query_Types">Literal Query Types</h3><p>EMF Facet also provides a few pre-defined query types that you can use when you only need a constant literal value:</p><ul><li>string : StringLiteralQuery</li><li>int : IntegerLiteralQuery</li><li>float : FloatLiteralQuery</li><li>EObject : EObjectLiteralQuery</li><li>true : TrueLiteralQuery</li><li>false : FalseLiteralQuery</li><li>null : NullLiteralQuery</li></ul><h3 id="Operation_Call_Query">Operation Call Query</h3><p>You can call a FacetOperation from another Facet attribute, reference or operation. For this, you implement the Facet element with an <b>OperationCallQuery</b> (which is a pre-defined query type). This query can take literal arguments (in the form of other queries), that will be evaluated and passed to the called FacetOperation. This can be useful in order to factorize the implementation of your Facet elements.</p><p>Example:</p><p><img border="0" src="../img/facetOperationCalls.png"/></p><p>In this example, we create a Facet to extend a "Writer" EClass, that represents a writer that has written a certain number of books, as represented by the attribute "numberOfBooksWritten". On this Facet, we define 3 boolean FacetAttributes, that classify the writer as "unproductive", "prolific", or "very prolific". To help implement these 3 Facet attributes, instead of implementing 3 separate queries, we create a more generic operation "isInProlificnessInterval" in order to factorize code. This operation takes 2 parameters (lower and upper bound), and returns whether the "numberOfBooksWritten" of the writer is between the lower and upper bounds. This FacetOperation is implemented by a JavaQuery. Once this FacetOperation is written, we can re-use it to create the 3 FacetAttributes. For this, we define the implementation of each FacetAttribute with an <b>OperationCallQuery</b> that references the operation "isInProlificnessInterval". Each <b>OperationCallQuery</b> contains two <b>IntegerLiteralQuery</b>, that give the values for the lower and upper bounds that are the parameters of the called FacetOperation.</p><p>The previous example only makes use of the <b>IntegerLiteralQuery</b> to return literal integer values. But you can use any query type: see <a href="#Literal_Query_Types">Literal Query Types</a>.</p><h4 id="Operation_Call_Query_source_and_return_type">Operation Call Query source and return type</h4><p>In <a href="#Query_source_and_return_type">Query source and return type</a>, we saw that the query's return type is the type of the FacetAttribute implemented by this query. But with an <b>OperationCallQuery</b>, we have a special case: the OperationCallQuery contains other queries used as arguments for the operation called by the OperationCallQuery. </p><p>The source and return type of an operation call query are computed in the same way as described in <a href="#Query_source_and_return_type">Query source and return type</a>. But the argument query is a bit special: its source type is the same as that of its parent OperationCallQuery, and its return type is the type of the corresponding parameter (i.e., the parameter at the same index in the list of parameters of the operation as the query's parameter in the list of arguments of the OperationCallQuery).</p><p>Here is an example with an operation that takes one parameter:</p><p><img border="0" src="../img/queryType3.png"/></p><ul><li>The source type of OperationCallQuery <b>q1</b> is EClass <b>c</b> because <b>q1</b> is contained in FacetAttribute <b>a</b> defined in Facet <b>f</b> that extends <b>c</b>.</li><li>The return type of OperationCallQuery <b>q1</b> is <b>t1</b>, because <b>t1</b> is the type of FacetAttribute <b>a</b> that contains <b>q1</b>.</li><li>The source type of the argument query <b>q2</b> is <b>c</b>, because <b>c</b> is the type of its parent query <b>q1</b></li><li>The return type of <b>q2</b> is <b>t2</b>, because <b>q2</b> is used to compute the value of parameter <b>p</b> in the invocation of operation <b>o</b>, and the type of <b>p</b> is <b>t2</b>.</li></ul><h2 id="Facet_manager">Facet manager</h2><p>The Facet manager is used to manipulate Facets. To obtain an instance of the FacetManager, you must ask the Facet manager factory:</p><pre>
IFacetManager facetManager = IFacetManagerFactory.DEFAULT.getOrCreateFacetManager(resourceSet);
</pre><p>The resourceSet parameter must be the same ResourceSet that was used to instantiate a FacetSet catalog manager in <code>IFacetSetCatalogManagerFactory#getOrCreateFacetSetCatalogManager</code>. </p><p>The Facet manager provides these important methods:</p><ul><li>isConforming(EObject, Facet) : test the conformance of a model element with a Facet</li><li>getOrInvoke(EObject, ETypedElement, Class) : gets the value for a model element of an ETypedElement, which may be a standard Ecore attribute, reference or operation, or a FacetAttribute, FacetReference or FacetOperation. </li></ul><p><font size="-2">
Copyright &#169; 2012 Mia-Software.
All rights reserved. This program and the accompanying materials
are made available under the terms of the Eclipse Public License 2.0
which accompanies this distribution, and is available at
<a href="https://www.eclipse.org/legal/epl-2.0/">https://www.eclipse.org/legal/epl-2.0/</a>.
Contributors: Nicolas Bros (Mia-Software); Laurent Pichierri (Soft-Maint) - Bug 375789 - Documentation
</font></p></body></html>